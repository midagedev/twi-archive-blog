---
title: "성능을 좀 손해보더라도 데이터베이스와 서비스를 큰 기능분류로 나누면 마이그레이션의 충격을 완화하고 가용성을 높힐 수 있는 방안중"
description: 간헐적 DB 장애에서 원인 확정보다 영향 범위 축소를 먼저 택했던 운영 판단과 커넥션 설정 경험을 정리했다.
pubDate: 2023-06-16T13:10:39+00:00
source: twitter
tags:
  - database
  - migration
  - availability
  - retries
  - connection-management
---

운영에서 오래 남는 장애는 크게 한 번 터지는 사고보다, 끊겼다가 다시 붙는 DB 오류가 반복되는 경우였다. 한 달 누적 다운타임이 조금씩 늘었고, 서비스는 겉보기엔 돌아가는데 일부 요청은 500으로 떨어졌다. 더 답답했던 건 전형적인 원인이 잘 보이지 않았다는 점이다. 느린 쿼리, 과도한 트랜잭션, 데드락 같은 신호가 뚜렷하지 않으면 분석은 길어지고 대응은 늦어진다.

당시에는 리드 레플리카 동기화 시점에 라이터나 리더 쪽 지연 작업이 있거나, 어떤 조건이 장애로 판정되어 자동 복구가 커넥션을 끊는 상황일 수 있다고 추정했다. 다만 이건 끝까지 추정이었고 결정적인 원인은 특정하지 못했다. 이런 상태에서는 원인 하나를 확정하려고 시간을 다 쓰기보다, 실패가 나와도 전체 서비스가 크게 흔들리지 않게 만드는 선택이 먼저 필요했다.

그래서 성능 일부를 감수하고 데이터베이스와 서비스를 큰 기능 분류로 나누는 방향을 택했다. 마이그레이션 충격을 한 지점에 몰지 않고, 장애가 나도 영향 반경을 작게 가져가려는 목적이었다. 커넥션 정책도 같이 손봤다. 장고는 기본 설정에서 커넥션 풀을 적극적으로 쓰지 않아서 재사용 설정만으로도 개선 여지가 있었고, Aurora Postgres에서는 클러스터 엔드포인트의 프록시 성격을 활용하면서 커넥션 최대 수명을 약 1분으로 짧게 두고 운영했다.

그래도 리트라이가 있다고 문제가 사라지진 않았다. 드라이버 기본 리트라이가 기대되는 구간에서도 한 주 동안 MongoDB 쿼리 요청에서 소켓 에러가 200건 이상 발생했고 500 응답도 남았다. 클라이언트 리트라이 덕분에 사용자 체감 영향은 일부 완화됐을 수 있지만, 그건 해결이라기보다 완충에 가깝다. 결국 적용 포인트는 명확하다. 원인을 100% 모를 때도 기능 경계를 나누고 커넥션 재사용·수명을 명시적으로 관리하면 장애의 크기와 전파를 줄일 수 있다. 다만 이 접근은 근본 원인 제거를 대신하지 못하니, 로그와 재현 조건을 끝까지 보강해 후속 수정으로 연결해야 한다.
