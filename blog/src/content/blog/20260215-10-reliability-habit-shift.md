---
title: "프로덕션에서 테스트 하면 안된다."
description: "장애를 겪은 뒤 검증 전략과 배포 습관을 어떻게 바꿨는지, 큐 폭증 사례와 함께 정리했다."
pubDate: 2023-03-29T11:11:07+00:00
source: twitter
tags:
  - reliability
  - production
  - deployment
  - sqs
  - incident
---

프로덕션에서 테스트 하면 안 된다. 그런데 프로덕션이 아니면 문제가 안 보일 때가 있다. 이 모순을 인정하지 않으면 운영은 늘 운에 기대게 된다. 스테이징에서 멀쩡하던 코드가 실제 트래픽, 실제 의존성, 실제 시간대에서 깨지는 순간을 겪고 나면, 기술 선택보다 먼저 검증 순서와 배포 습관을 다시 보게 된다.

한 번은 금요일 오후 6시에 프로덕션 배포가 올라가는 장면만 보고도 공포감이 들었다. 배포 시스템이 안정적이어도 운영 리스크는 시간대와 함께 커진다. 30분만 멈춰도 손실이 큰 서비스라면, “배포가 되느냐”보다 “문제가 나면 지금 바로 붙을 수 있느냐”가 더 중요하다. 그 뒤로는 배포 가능 여부보다 배포 시점과 대응 가능 인력을 먼저 확인하게 됐다.

EKS에 SQS를 붙인 작업에서는 롤백 대비로 남겨둔 기존 노드가 메시지를 가져가는 상황부터 복잡성이 시작됐다. 라우팅 위주 구조에서는 덜 보이던 문제가 소비자 수, 재시도, 롤백 타이밍에서 동시에 터졌다. 결국 실패 메시지를 삭제하지 않고 서킷브레이커를 피해 다시 SQS에 넣는 버그 때문에 테스트 메시지 1건이 5분 만에 300만 건으로 증식했고, CPU 오토스케일링으로 노드까지 늘어났다. 기능 버그 하나가 운영비와 안정성 문제로 바로 확대되는 전형적인 패턴이었다.

외부 장애도 예외가 아니다. Azure가 멈춘 밤에는 우리 서비스도 같이 멈췄다. 원인이 우리 코드가 아니어도 사용자에게는 “서비스 장애”로 보인다. 그래서 외부 의존성은 변명이 아니라 설계 입력값으로 다뤄야 한다. 장애 공지는 빠르게, 영향 범위는 구체적으로, 복구 예상은 보수적으로 전달하는 기본기를 놓치지 않는 쪽이 결국 신뢰를 지킨다.

지금은 배포 전후에 같은 질문을 반복한다. 실패 경로가 늘어났는지, 재시도와 큐 적체 상한이 정의돼 있는지, 롤백 노드가 중복 소비를 만들지 않는지, 야간에도 실제 대응 가능한지. 장애가 나면 자괴감이 먼저 오지만 거기서 오래 머물면 다음 사고를 막지 못한다. 감정을 추스르고 바로 재발 방지 항목을 남기는 습관이, 프로덕션 테스트 딜레마를 현실적으로 다루는 가장 실용적인 방법이었다.
