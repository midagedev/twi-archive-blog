---
title: 프로덕션 희귀 오류를 다루는 디버깅 플레이북
description: 스테이징에서 안 보이던 오류를 쿠키 경계, 배포 운영, 과거 PR 레퍼런스로 풀어낸 실무 기준.
pubDate: 2023-03-29T11:11:07+00:00
source: twitter
tags:
  - debugging
  - production
  - deployment
  - incident-response
  - engineering
---

프로덕션 디버깅에서 가장 답답한 순간은 원칙과 현실이 충돌할 때다. 프로덕션에서 테스트하면 안 되는데, 문제는 프로덕션에서만 드러난다. 실제로 스테이징에서는 잘 돌던 기능이 프로덕션에서 일부 고객에게만 실패한 적이 있었다. 재현이 안 되면 코드 변경보다 먼저 환경 차이를 의심해야 했고, 당시에도 영향 사용자 비율은 바로 확정하기 어려웠다.

원인은 애플리케이션 내부가 아니라 요청 경계에 있었다. 다른 서브도메인 서비스가 도메인 레벨 쿠키를 사용하고 있었고, 그 쿠키가 요청마다 누적되어 들어왔다. 특정 사용자에게는 쿠키가 많이 쌓여 요청 헤더가 커졌고, 결국 Nginx 기본 최대 요청 헤더 크기를 넘겨 일부 요청만 실패했다. 로직은 정상인데 인프라 기본값과 브라우저 동작이 만나면서 깨진 케이스였다.

그 뒤로 희귀 오류 대응은 플레이북 형태로 고정했다. 실패 요청이 나오면 헤더 크기와 쿠키 개수부터 본다. 쿠키의 Domain, Path, 만료 정책이 서비스 경계를 넘지 않는지 확인한다. 스테이징에서 재현되지 않으면 거기서 멈추지 않고, 프로덕션 트래픽 특성 차이를 체크 항목으로 남긴다. 로그도 사용자군 단위로 남겨서 원인 후보를 빠르게 줄일 수 있게 했다.

배포 운영 기준도 함께 바꿨다. 배포 시스템이 안정적이어도 금요일 저녁 배포는 여전히 위험하다. 짧은 중단도 손실이 큰 서비스라면 배포 성공 자체보다 배포 직후 관찰 시간이 더 중요하다. 최소한 책임자가 일정 시간 지표와 에러율을 확인하고, 이상 징후가 보이면 바로 되돌릴 수 있게 사람과 절차를 붙여 두는 쪽이 안전했다.

디버깅 속도를 가장 올린 습관은 “우리만의 문제는 드물다”는 전제였다. 실제로 URL 이중 인코딩 문제도 과거에 이미 머지된 PR에서 논의와 테스트 케이스를 찾아 실마리를 얻었다. 그래서 지금은 새 이슈를 받으면 추측부터 하지 않고, 내부 PR 기록과 외부 레퍼런스를 먼저 훑는다. 플레이북의 핵심은 특별한 감각이 아니라, 재현이 어려운 문제를 반복 가능한 확인 절차로 바꾸는 데 있다.
