---
title: "eks에서 sqs붙여 쓰는거 첨 해봤다."
description: "비동기 전환 과정에서 터진 큐 증식 장애와, 테스트 우선으로 안전장치를 다시 세운 기록."
pubDate: 2023-10-12T12:34:09+00:00
source: twitter
tags:
  - backend
  - eks
  - sqs
  - async
  - testing
---

서비스 간 HTTP 통신에서 타임아웃이 늘고, 비동기 처리로 넘긴 작업이 로그 없이 사라지는 일이 겹쳤다. API 명세 변경이 반영되지 않아 로그인 실패나 상품 이용 불가 같은 사용자 문제도 나왔다. Datadog을 붙여도 구간마다 트레이스가 끊겨 원인 추적이 매번 늦었다. 그래서 메시지 브로커 전환은 기능 추가가 아니라, 실패를 다루는 방법부터 정리해야 하는 작업이라는 걸 먼저 확인했다.

EKS에 SQS를 처음 붙였을 때도 비슷한 벽을 맞았다. 메시지 풀러 코드를 수정해 재배포했는데, 롤백 대비로 남겨둔 기존 노드가 메시지를 가져가면서 흐름이 꼬였다. 더 크게는 실패 큐를 지우지 않고 서킷브레이커를 피해 다시 SQS에 넣는 버그가 있었고, 5분 만에 테스트 메시지 1개가 300만 개로 증식했다. CPU 부하 오토스케일링으로 노드까지 늘어나면서 장애가 증폭됐다. 정확히 어느 지점에서 첫 증식이 시작됐는지는 로그 단절 구간이 있어 단정하기 어려웠다.

그 뒤로는 전환 작업을 “일단 붙여보고 보자”로 시작하지 않았다. 실제로 한 작업에서는 검증 코드 없이 카프카 대체를 진행하려는 흐름을 멈추고, API 두 개와 기존 메시지 흐름을 함께 검증하는 e2e 테스트부터 만들었다. 구현보다 먼저 실패 경로를 재현하고, 실패 메시지를 어떻게 처리할지 규칙을 테스트로 고정했다. 이 순서로 가면 속도는 잠깐 느려져도, 재배포와 롤백이 섞이는 구간에서 사고 반경이 확실히 줄었다.

나는 테스트 코드를 예금에 가깝게 본다. 급한 구현이 필요할 때는 기술부채라는 대출을 당길 수밖에 없는데, 예금이 있으면 버틸 수 있는 선택지가 생긴다. 반대로 기반이 없으면 같은 기능을 더 비싼 비용으로 급히 막게 된다. 비동기 시스템은 라우팅만 맞춘다고 끝나지 않는다. 삭제, 재시도, 관측, 롤백이 동시에 맞물리도록 작은 검증을 먼저 쌓는 게 결국 가장 현실적인 안전장치였다.
