---
title: "postgres 최적화 하나 경험, 인덱스를 쓰더라도 인덱스의 크기가 크게 되면 일단 스캔하는데 오래걸린다."
description: 큰 인덱스 스캔 병목을 partial index로 줄여 약 10배 개선한 경험을 정리했다.
pubDate: 2024-01-02T13:44:58+00:00
source: twitter
tags:
  - postgres
  - database
  - partial-index
---

한 번은 Postgres 쿼리가 인덱스를 타는데도 체감이 느렸다. 인덱스만 쓰면 충분할 거라고 생각했지만, 데이터가 커지자 인덱스 자체를 훑는 시간도 꽤 커졌다. 병목이 테이블 스캔이 아니라 큰 인덱스 스캔에 있다는 점을 뒤늦게 확인했다.

조회 패턴을 다시 보니 자주 읽는 데이터는 전체의 일부였고, 쿼리에는 반복되는 필터 조건이 있었다. 그래서 테이블 분리보다 먼저 그 조건으로 partial index를 만들었다. 구조를 크게 바꾸지 않고, 실제로 많이 쓰는 구간만 따로 인덱싱한 선택이었다. 아이디어는 ChatGPT와 대화하면서 바로 실험해봤다.

결과는 명확했다. 같은 경로에서 속도가 약 10배 좋아졌다. 이 경험 이후로 데이터가 커졌다는 이유만으로 테이블을 먼저 나눠야 한다고 보지 않게 됐다. 분리할 조건이 명확하다면 테이블 대신 인덱스를 조건별로 나누는 방식만으로도 비슷한 효과를 기대할 수 있었다.

물론 이 방법이 모든 경우에 맞는 건 아니다. partial index는 해당 조건을 타는 쿼리에서만 이득이 난다. 그래서 먼저 할 일은 큰 구조 변경이 아니라 접근 패턴 확인이다. 반복되는 필터가 분명할 때는, 작은 인덱스 설계 변경이 더 빠르고 실용적인 첫 선택이 될 수 있다.
