---
title: "django의 prefetch_related는 디비부하를 줄일 수 있는 좋은 방법 중 하나지만 prefetch 해 온 결과물을 조"
description: "prefetch_related의 장점은 유지하되, 캐시 이상 상황에서 드러난 CPU 조합 비용과 select_related의 역할을 다시 본 기록."
pubDate: 2024-12-03T02:40:58+00:00
source: twitter
tags:
  - django
  - orm
  - prefetch_related
  - select_related
  - performance
---

prefetch_related는 디비 부하를 줄일 때 자주 쓰는 도구다. 나도 그렇게 이해하고 있었는데, 캐시가 가득 찬 어느 날 앱 서버 40대가 동시에 버거워하는 상황을 겪으면서 관점을 다시 잡게 됐다. 쿼리 수만 줄였다고 끝나는 게 아니라, 가져온 결과를 애플리케이션에서 조합하는 비용이 CPU로 그대로 온다는 점을 운영에서 체감했다.

문제가 컸던 구간은 주요 쿼리셋에 prefetch 대상 모델이 20개가량 붙어 있었고, 요청 빈도도 높은 경로였다. 평소엔 버티던 구조가 캐시 이슈와 만나면서 병목이 드러난 셈이다. 그래서 이 경험을 prefetch 자체의 문제로 보지는 않았다. 어떤 조건에서 비용이 커지는지 명확히 보는 쪽이 맞았다.

이 과정에서 select_related를 다시 봤다. 이전에는 prefetch와 비교해 장점이 크게 와닿지 않았고, 팀 안에 select_related를 지양하는 가이드도 있었다. 그런데 적당한 곳에서는 조합 부담을 DB join으로 넘길 수 있다는 점이 분명한 장점이었다. 결국 둘 중 하나를 고집하기보다, 부하가 어디에서 터지는지 기준으로 선택하는 게 실전적이었다.

정리하면 결론은 단순하다. 캐시를 안정적으로 쓰는 게 가장 좋고, prefetch_related도 여전히 유효하다. 다만 요청량이 높고 prefetch 범위가 커질 때는 앱 서버 CPU 비용을 함께 계산해야 한다. DB는 스케일아웃이 쉽지 않고 앱 서버는 상대적으로 유연하다는 제약까지 같이 두고, prefetch를 무조건이 아니라 조건부 기본값으로 다루는 게 안전했다.
