---
title: 프로덕션 DB 커넥션 불안정에 대응하며 정리한 기준
description: 원인이 불명확한 커넥션 끊김 상황에서 연결 수명, 재사용 설정, 쿼리 타입 정합성으로 위험을 줄인 운영 기록.
pubDate: 2024-04-04T08:50:32+00:00
source: twitter
tags:
  - database
  - postgresql
  - django
  - incident-response
  - query-tuning
---

운영 중 DB 커넥션이 간헐적으로 끊겼다. 패턴만 보면 애플리케이션 버그보다는 인프라 이벤트에 가까웠다. 리드 레플리카 동기화 시점에 라이터나 리더 쪽 지연 작업이 겹치거나, 시스템이 장애 징후로 판단해 자동 복구 과정에서 커넥션을 정리했을 가능성을 먼저 의심했다. 다만 끝까지 추정 수준이었고 결정적인 원인은 확인하지 못했다. 느린 쿼리, 과도한 트랜잭션, 데드락 같은 전형적인 신호도 뚜렷하지 않았다.

그래서 원인 규명과 완화 작업을 분리했다. Aurora Postgres에서는 클러스터 엔드포인트가 프록시 역할을 일부 해주기 때문에 연결 경로를 더 복잡하게 늘리지 않고, 커넥션 최대 수명을 약 1분으로 짧게 두는 쪽을 택했다. 오래 붙어 있는 세션을 빠르게 순환시켜 장애 구간에서 불안정한 연결이 누적되지 않게 하려는 의도였다. 재시도 로직을 크게 키우는 방식보다 운영 복잡도가 낮고, 현장에서 판단하기도 쉬웠다.

애플리케이션 레이어에서는 장고 기본 설정을 다시 봤다. 기본값만 두면 커넥션 풀을 바로 쓰지 않기 때문에, 최소한 커넥션 재사용 설정을 켜는 것만으로도 개선되는 구간이 있었다. 연결/해제 비용이 줄고 순간적인 접속 변동도 완화됐다. 이건 화려한 최적화라기보다 장애 구간에서 변수를 줄이는 기본기였다.

쿼리도 같이 정리했다. `EXPLAIN`에서 같은 조건이라도 `date`를 줄 때는 인덱스 스캔이 보이지 않고 `datetime`일 때만 인덱스 스캔이 나온 사례가 있었다. 그래서 ORM 필터 타입, 컬럼 타입, 캐스팅 경로를 맞추는 점검 항목을 따로 뒀다. 이 조치로 모든 끊김이 사라졌다고 단정할 수는 없다. 그래도 원인이 불명확한 사건일수록 연결 수명, 재사용, 타입 정합성처럼 통제 가능한 레버를 먼저 고정해두는 편이 재발 대응에 유효했다.
