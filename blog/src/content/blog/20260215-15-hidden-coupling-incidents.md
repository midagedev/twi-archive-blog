---
title: "CDN겸 로드밸런서가 장애가 났다는데 프라이빗네트워크내의 서비스간 호출이 타임아웃이 났다."
description: "로컬에서는 멀쩡한데 운영에서만 터지는 숨은 결합을 겪으며, 호출 경로와 경계 조건을 다시 점검한 기록."
pubDate: "2023-10-11T13:53:04+00:00"
source: twitter
tags:
  - 장애분석
  - 신뢰성
  - 분산시스템
  - 비동기처리
  - 운영경험
---

요즘 장애를 보면 먼저 드는 생각은, 부하가 CPU로 정직하게 보이면 오히려 다행이라는 점이다. 더 힘든 건 지표가 조용한데 요청이 한 번에 무너지는 경우다. 점진적으로 나빠지는 문제보다 이런 유형이 대응을 더 어렵게 만든다. 데드리프트에서 마지막 실패가 평균 근력이 아니라 가장 약한 한 지점에서 터지듯, 서비스도 전체 성능이 아니라 숨은 결합 하나가 시스템을 멈추게 한다.

가장 아팠던 사례는 CDN 겸 로드밸런서 장애였다. 프라이빗 네트워크 안에서 끝나야 할 서비스 간 호출이 같이 타임아웃 났다. 확인해 보니 여러 내부 호출이 직접 통신이 아니라 외부 경로로 나갔다가 로드밸런서를 거쳐 다시 들어오고 있었다. 평소에는 티가 안 났지만 경계 하나가 흔들리자 내부 트래픽까지 연쇄로 막혔다. 내부 호출이라는 이름만 믿고 실제 경로를 보지 않은 결과였다.

트랜잭션과 Celery를 엮을 때도 비슷했다. 비동기 작업이 적을 때는 로컬 테스트가 잘 돌았고 별문제가 없어 보였다. 그런데 운영에서는 여기저기서 실패가 터졌다. 트랜잭션 경계 안팎에서 작업이 언제 커밋되고 언제 소비되는지가 어긋나기 시작하면, 테스트 통과 여부와 실제 안정성이 분리된다. 초기에 팀이 트랜잭션 사용을 조심하던 이유를 나중에야 체감했다.

데이터베이스에서도 같은 패턴을 봤다. Aurora 리드 레플리카를 서버리스로 쓰는 환경에서 부하 구간마다 커넥션 수가 급감했고, CPU는 멀쩡한데 복제 지연 지표가 튀는 시점이 겹쳤다. 자동 복구성 동작으로 연결이 정리됐을 가능성을 의심했지만, 당시에는 결정적인 원인을 특정하지 못했다. 느린 쿼리나 데드락이 바로 안 보인다고 안전하다고 단정하면 안 된다는 점만 분명해졌다.

이후에는 장애 대응보다 먼저 결합을 드러내는 작업을 우선순위로 둔다. 호출 경로를 논리적 내부/외부가 아니라 실제 네트워크 홉 기준으로 적고, 비동기 처리는 트랜잭션 경계와 재시도 조건을 분리해 본다. CI와 배포 파이프라인도 숨은 기본 설정이 전체 큐를 막지 않게 주기적으로 점검한다. 화려한 최적화보다, 어디가 실패하면 밥상이 한 번에 엎어지는지 먼저 찾는 편이 운영에서는 훨씬 싸다.
