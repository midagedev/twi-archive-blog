---
title: 장애 분석에서 숨은 결합을 찾는 과정
description: 지표가 정상처럼 보여도 장애가 급격히 터지는 이유를, 숨은 트래픽 경로와 레플리카 지연 사례로 정리했다.
pubDate: 2023-10-11T13:53:04+00:00
source: twitter
tags:
  - 장애분석
  - 시스템운영
  - 아키텍처
  - AWS
  - PostgreSQL
---

최근 장애를 보며 먼저 확인하는 기준이 바뀌었다. 부하가 늘 때 CPU가 같이 오르면 오히려 추적이 쉽다. 더 까다로운 경우는 지표가 평온한데 요청이 갑자기 무너지는 상황이다. 이런 장애는 점진적으로 나빠지지 않고 한순간에 터진다. 평균값이나 대시보드 한 장으로 시스템 상태를 이해하려 하면, 실제 실패 지점은 끝까지 안 보일 수 있다.

한 번은 CDN 겸 로드밸런서 장애가 먼저 관측됐는데, 이상하게 프라이빗 네트워크 내부 서비스 호출도 타임아웃이 났다. 확인해 보니 일부 내부 호출이 내부에서 끝나지 않고 외부로 나갔다가 로드밸런서를 거쳐 다시 들어오고 있었다. 평소에는 문제를 만들지 않던 경로가 경계 장애와 함께 한꺼번에 드러난 셈이다. 코드상으로는 “내부 통신”처럼 보여도, 실제 트래픽 경로가 다르면 장애 전파 방식도 완전히 달라진다.

DB에서도 비슷한 형태를 겪었다. AWS RDS PostgreSQL에서 서버리스 리드 레플리카를 쓰는 중, 부하가 있는 시점마다 커넥션 수가 급격히 줄고 AuroraReplicaLagMaximum이 튀는 패턴이 있었다. CPU 지표는 특별히 나쁘지 않았고, 느린 쿼리나 과도한 트랜잭션, 데드락도 뚜렷하지 않았다. 레플리카 동기화 지연이나 자동 복구 과정에서 연결이 끊겼을 가능성을 의심했지만, 당시에는 추정 이상으로 원인을 확정하지 못했다는 한계가 남았다.

이후에는 분석 순서를 고정했다. 호출 구조를 서비스 다이어그램이 아니라 실제 네트워크 홉 기준으로 다시 그리고, 내부 호출이라도 외부 경계를 통과하면 별도 의존성으로 분리해 본다. 또 CPU나 쿼리만 따로 보지 않고 타임아웃, 커넥션 감소, 레플리카 지연을 같은 시간축에 겹쳐 본다. 급격한 장애는 “전체가 조금씩 느려지는 문제”보다 가장 약한 연결 하나가 끊기면서 생기는 경우가 많았다.

모든 사건에서 단일 원인을 빠르게 확정할 수는 없다. 그래도 숨은 결합을 먼저 의심하면 대응 우선순위가 명확해진다. 내부 트래픽의 우회 경로를 줄이고, 경계 통과를 명시적으로 관리하고, 레플리카 지연과 커넥션 급락 조합을 조기에 감지하면 같은 종류의 붕괴 가능성은 낮출 수 있다. 장애 분석은 완벽한 정답을 찾는 일보다, 약한 고리를 드러내고 다음 실패 비용을 줄이는 일에 더 가깝다.
